"undefined"==typeof globalThis&&(window.globalThis=window),function(){"use strict";function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(o=r.key,i=void 0,"symbol"==typeof(i=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(o,"string"))?i:String(i)),r)}var o,i}function t(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function n(){return n=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},n.apply(this,arguments)}function r(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,i(e,t)}function o(e){return o=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},o(e)}function i(e,t){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},i(e,t)}function s(e,t,n){return s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}()?Reflect.construct.bind():function(e,t,n){var r=[null];r.push.apply(r,t);var o=new(Function.bind.apply(e,r));return n&&i(o,n.prototype),o},s.apply(null,arguments)}function a(e){var t="function"==typeof Map?new Map:void 0;return a=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return s(e,arguments,o(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),i(r,e)},a(e)}function u(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function f(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return c(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?c(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function l(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var h=function(e,t){try{var n,r,o,i=function(e){var t,n=!1;if(s)return e;function r(e){return n?e:{body:t,offgridTimeout:c,status:u.status,loginSignal:o}}var o="",i=l((function(){u.headers.has(T)&&(o=u.headers.get(T)||"");var e=function(){if(204!==u.status)return Promise.resolve(u.json()).then((function(e){t=e}));t={}}();if(e&&e.then)return e.then((function(){}))}),(function(e){var t={offgridTimeout:c,status:-1};return t.error=e instanceof Error?e:new Error("unknown error"),n=!0,t}));return i&&i.then?i.then(r):r(i)},s=!1;t.method=null!=(n=t.method)?n:"POST";var a=new AbortController;(null==t?void 0:t.signal)&&t.signal.addEventListener("abort",a.abort);var u=void 0,c=x,f=!1,h=0,g=d((function(){return l((function(){function n(){return"POST"!==t.method&&"PUT"!==t.method&&"DELETE"!=t.method||(i.set(N,q),(null==(o=t.session)?void 0:o.accessToken)&&i.set("Authorization","Bearer "+t.session.accessToken)),s.headers=i,Promise.resolve(fetch(e,s)).then((function(t){function n(){if(u.headers.has(U)){var e=u.headers.get(U)||x.toString();c=parseInt(e)||x}if(u.status>=500&&504!==u.status)throw c=D,new O("authority offgrid",u.status);if(u.headers.has(j)){var t=u.headers.get(j)||j.toString(),n=parseInt(t)||3e3;throw new I("Too chatty, will retry after "+n+" millis",n)}return function(){if(!u.ok){var e=function(){throw new O(u.statusText||"unknown response error",u.status)},t=l((function(){return Promise.resolve(u.json()).then((function(e){console.error(e)}))}),(function(){}));return t&&t.then?t.then(e):e()}}()}if((u=t).headers.has(A)){var r=u.headers.get(A)||"<not set>";J(r),i.set(N,r)}var o=function(){if(u.headers.has(C)){var t=u.headers.get(C),n=function(){if(t===R)return s.headers=i,Promise.resolve(fetch(e,s)).then((function(e){u=e}))}();if(n&&n.then)return n.then((function(){}))}}();return o&&o.then?o.then(n):n()}))}h=window.setTimeout((function(){f=!0,a.abort()}),L);var i=new Headers({accept:"application/json","nrk-fetch":"1"}),s={credentials:"include",method:t.method,signal:a.signal};t.body&&(s.body=t.body,i.set("content-type","application/json"));var d=function(){if(function(e){if("GET"===e)return!1;if(void 0===q||""===q)return!0;var t=localStorage.getItem(W);if(null==t)return!0;return!1}(t.method))return Promise.resolve(m(null!=(r=t.signal)?r:null)).then((function(){}))}();return d&&d.then?d.then(n):n()}),(function(e){var t={offgridTimeout:c,status:-1};return f?t.error=new Error("response timed out"):e instanceof I?t.error=e:e instanceof O?(t.error=e,t.status=e.status):e instanceof Error?t.error=e:t.error=new Error("unknown error"),s=!0,t}))}),(function(e,n){if(window.clearTimeout(h),t.signal&&t.signal.removeEventListener("abort",a.abort),e)throw n;return n}));return Promise.resolve(g&&g.then?g.then(i):i(g))}catch(e){return Promise.reject(e)}};function d(e,t){try{var n=e()}catch(e){return t(!0,e)}return n&&n.then?n.then(t.bind(null,!1),t.bind(null,!0)):t(!1,n)}var g,v,p=function(e,t){return Promise.resolve(h(e,t)).then((function(n){var r=!1,o=function(){if(n.error&&n.error instanceof I){var o=n.error.millis;return Promise.resolve((i=o,new Promise((function(e){return setTimeout(e,i)})))).then((function(){return Promise.resolve(h(e,t)).then((function(e){return r=!0,e}))}))}var i}();return o&&o.then?o.then((function(e){return r?e:n})):r?o:n}))},m=function(e){try{var t=new AbortController;e&&e.addEventListener("abort",t.abort);var n=void 0,r=0,o=d((function(){return l((function(){r=window.setTimeout((function(){t.abort()}),L);var e={credentials:"include",headers:new Headers({accept:"application/json","nrk-fetch":"1"}),method:"POST",signal:t.signal};return Promise.resolve(fetch("/auth/csrf_init",e)).then((function(e){(n=e).headers.has(A)&&J(n.headers.get(A)||"<not set>")}))}),(function(e){console.error("could not initialize csrf token properly",e)}))}),(function(n,o){if(window.clearTimeout(r),e&&e.removeEventListener("abort",t.abort),n)throw o;return o}));return Promise.resolve(o&&o.then?o.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},w=function(e,t,n){if(!t.has(e))throw TypeError("Cannot "+n)},y=function(e,t,n){return w(e,t,"read from private field"),n?n.call(e):t.get(e)},_=function(e,t,n){if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,n)},b=function(e,t,n,r){return w(e,t,"write to private field"),r?r.call(e,n):t.set(e,n),n},S=function(e,t,n,r){return{set _(r){b(e,t,r,n)},get _(){return y(e,t,r)}}};(v=g||(g={}))[v.debug=0]="debug",v[v.info=1]="info",v[v.warn=2]="warn",v[v.error=3]="error";var P=1;var E=function(){function e(e,t){void 0===t&&(t=k),this.name=e,this._handler=t}var t=e.prototype;return t.debug=function(){if(P<=0){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._handler.apply(this,[0,this.name].concat(t))}},t.info=function(){if(P<=1){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._handler.apply(this,[1,this.name].concat(t))}},t.warn=function(){if(P<=2){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._handler.apply(this,[2,this.name].concat(t))}},t.error=function(){if(P<=3){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._handler.apply(this,[3,this.name].concat(t))}},e}();function k(e,t){for(var n,r,o,i,s=arguments.length,a=new Array(s>2?s-2:0),u=2;u<s;u++)a[u-2]=arguments[u];switch(e){case 0:(n=console).debug.apply(n,["[DEBUG] "+t].concat(a));break;case 1:(r=console).info.apply(r,["[INFO] "+t].concat(a));break;case 2:(o=console).warn.apply(o,["[WARN] "+t].concat(a));break;case 3:(i=console).error.apply(i,["[ERROR] "+t].concat(a))}}var O=function(e){function t(t,n){var r;return(r=e.call(this,t)||this).name="HTTPError",r.status=n,r}return r(t,e),t}(a(Error)),I=function(e){function t(t,n){var r;return(r=e.call(this,t,429)||this).name="BackoffRetry",r.millis=n,r}return r(t,e),t}(O),L=6e3,x=0,D=3e4,U="offgrid-duration",j="backoff-retry-after-millis",T="login-signal",C="csrf-status",R="rejected",A="nrk-proxy-csrf",N="nrk-proxy-csrf",W="nrk-login-client-csrf-load-time",M="nrk-login-csrf-load-time";if("undefined"!=typeof window&&"localStorage"in window){var F=localStorage.getItem(M);"string"==typeof F&&(localStorage.setItem(W,F),localStorage.removeItem(M))}var q="";function G(e,t){return p(e,{method:"GET",signal:t})}function B(e,t,n,r){return p(e,{method:"POST",signal:r,body:t?JSON.stringify(t):void 0,session:n})}function H(e,t,n,r){return p(e,{method:"PUT",signal:r,body:JSON.stringify(t),session:n})}function J(e){q=e;try{var t=e.substring(0,e.indexOf("."));localStorage.setItem(W,t)}catch(e){console.error("could not set csrf token info in local storage and session storage",e)}}function z(e){var t=localStorage.getItem(e);if(t)return JSON.parse(t)}function V(e,t){t?localStorage.setItem(e,JSON.stringify(t)):localStorage.removeItem(e)}function K(e){if(!navigator||!navigator.cookieEnabled)throw new Error("Missing navigator or cookie-support");var t=e+"=",n=document.cookie.split(";").map((function(e){return e.trim()})).find((function(e){return e.startsWith(t)}));return n?n.split("=")[1]:void 0}function $(e,t,n){var r=new Date(Date.now()+n);document.cookie=e+"="+t+";expires=$"+r.toUTCString()+";path=/"}function Q(e){var t=new Date(0);document.cookie=e+"=;expires="+t.toUTCString()+";path=/"}var X,Y,Z="/auth/session/tokenforsub/{sub}",ee="/auth/contextinfo",te="/auth/urlwithexpiry/generate",ne="login_signal",re="nrk-login-client-state",oe="nrk-login-client-archive",ie="nrk-login-client-identity",se="nrk-login-context-info";(Y=X||(X={})).refresh="refresh",Y.refreshWithDefaultIdentity="refresh_default_identity",Y.refreshOpsession="refresh_opsession",Y.logout="signout",Y.logoutOpsession="signout_opsession",Y.reauthenticate="reauthenticate";var ae,ue,ce,fe,le="login_authority_override",he="nrkdebug",de="nrk-disable-login-in-client",ge=function(){function e(e,t){_(this,ae,void 0),_(this,ue,void 0),_(this,ce,void 0),b(this,ae,e),b(this,ce,"1"===K(de)),b(this,ue,t)}var n=e.prototype;return n.getCurrentAuthorityUrl=function(){try{var e,t,n=this;return Promise.resolve(B("/auth/debug/currentAuthority")).then((function(r){return 200==r.status?null!=(t=null==(e=r.body)?void 0:e.frontchannelUri)?t:"https://innlogging.nrk.no":n.authorityOverride?n.authorityOverride:"https://innlogging.nrk.no"}))}catch(e){return Promise.reject(e)}},n.prepInviteCodeNeverDoThisInProduction=function(){try{return Promise.resolve(y(this,ae).getSession()).then((function(e){return Promise.resolve(B("/auth/debug/generateInviteCodeChallenge",{iSolemnlySwear:"ThisIsNotProduction"},e)).then((function(e){if(200==e.status&&e.body)return e.body;throw"Could not prep invite code"}))}))}catch(e){return Promise.reject(e)}},n.redeemInviteCodeAndReturnSessionNeverDoThisInProduction=function(e,t){try{return Promise.resolve(B("/auth/debug/redeemInviteCode",{inviteCode:e,codeVerifier:t.codeVerifier})).then((function(e){if(200==e.status&&e.body)return e.body;throw"Could not redeem invite code"}))}catch(e){return Promise.reject(e)}},n.overrideAuthority=function(e){try{var t=this,n=t.authorityOverride,r=function(){if(n!==e){var r=l((function(){return e?$(le,e,31536e6):Q(le),y(t,ue)._updateState({state:"LoggedOut",userAction:"Nothing"}),Q(se),Promise.resolve(y(t,ae)._updateContextInfo()).then((function(){}))}),(function(e){t._handleError(e)}));if(r&&r.then)return r.then((function(){}))}}();return Promise.resolve(r&&r.then?r.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},n.setEnvironment=function(e){try{switch(e){case"test":return void this.overrideAuthority("https://test-innlogging.nrk.no");case"stage":return void this.overrideAuthority("https://stage-innlogging.nrk.no");case"preprod":return void this.overrideAuthority("https://preprod-innlogging.nrk.no");case"prod":return void this.overrideAuthority("https://innlogging.nrk.no");case"custom":throw new Error("cannot set environment to 'custom', use overrideAuthority() instead");default:this.overrideAuthority(void 0)}}catch(e){this._handleError(e)}},n.setOffgrid=function(e){y(this,ue).goOffgrid(e)},n.clearOffgrid=function(){try{return this.refresh(),Promise.resolve()}catch(e){return Promise.reject(e)}},n.refresh=function(){try{return Promise.resolve(y(this,ae)._refresh())}catch(e){return Promise.reject(e)}},n._handleError=function(e){y(this,ae)._handleError(e)},n.getAppQrCodeUrl=function(e){return e.replace("app-qr","app-qr2")},n.doGet=function(e){try{return Promise.resolve(G(e))}catch(e){return Promise.reject(e)}},n.doPost=function(e,t,n){try{return Promise.resolve(B(e,t,n))}catch(e){return Promise.reject(e)}},n.doPut=function(e,t,n){try{return Promise.resolve(H(e,t,n))}catch(e){return Promise.reject(e)}},n.logInTestUsers=function(e){try{var t=this,n=new URL("/auth/testusers/login",window.location.href);return Promise.resolve(B(n.href,e,void 0)).then((function(e){return Promise.resolve(y(t,ue)._handleSessionDataFetchResponse(e,void 0,void 0)).then((function(){}))}))}catch(e){return Promise.reject(e)}},n.setRequirementsForTestUser=function(e,t){try{var n=this;return Promise.resolve(y(n,ue)._changeIdentity(e)).then((function(e){var r=new URL("/auth/testusers/setrequirements",window.location.href);return Promise.resolve(B(r.href,t,e)).then((function(e){return Promise.resolve(y(n,ue)._handleSessionDataFetchResponse(e,void 0,void 0)).then((function(){}))}))}))}catch(e){return Promise.reject(e)}},t(e,[{key:"_client",get:function(){return y(this,ae)}},{key:"loginDisabled",get:function(){return y(this,ce)},set:function(e){try{b(this,ce,e),e?$(de,"1",36e5):Q(de),this.refresh()}catch(e){this._handleError(e)}}},{key:"authorityOverride",get:function(){try{return K(le)}catch(e){return}}},{key:"environment",get:function(){switch(this.authorityOverride){case void 0:return;case"https://test-innlogging.nrk.no":return"test";case"https://stage-innlogging.nrk.no":return"stage";case"https://preprod-innlogging.nrk.no":return"preprod";case"https://innlogging.nrk.no":return"prod";default:return"custom"}}},{key:"networkDebugging",get:function(){try{var e=K(he);return"on"===e?"_no_case_id_":e&&e.startsWith("on-")?e.substr(3):void 0}catch(e){return void this._handleError(e)}},set:function(e){try{e?$(he,"on-"+e,3e5):""===e?$(he,"on",3e5):Q(he)}catch(e){this._handleError(e)}}}]),e}();function ve(e,t){var n=parseInt(e,10);return Number.isInteger(n)?n:t}ae=new WeakMap,ue=new WeakMap,ce=new WeakMap;var pe=function(){function e(e){_(this,fe,void 0),b(this,fe,e)}var n=e.prototype;return n.toJSON=function(){return y(this,fe)},n.userConformsToRequirements=function(e){if(!this.user)return!1;if(void 0===e.requirements)return!0;for(var t,n=f(e.requirements);!(t=n()).done;){var r=t.value,o=r,i=1;if(-1!==r.indexOf(":")){var s=r.split(":");o=s[0],i=ve(s[1],1)}if("portability"!==o||"no"!==this.user.claims["nrk/cor"]){if("portability"===o&&"no"!==this.user.claims["nrk/cor"])return!1;if(void 0===this.user.claims["nrk/consent/"+o])return!1;if(ve(this.user.claims["nrk/consent/"+o],0)<i)return!1}}return!0},t(e,[{key:"_state",get:function(){return y(this,fe)}},{key:"accessToken",get:function(){var e;return null==(e=y(this,fe).sessionData)?void 0:e.accessToken}},{key:"expires",get:function(){return y(this,fe).expires}},{key:"serverEpochExpiry",get:function(){var e;return null==(e=y(this,fe).sessionData)?void 0:e.serverEpochExpiry}},{key:"idToken",get:function(){if(!(void 0===y(this,fe).sessionData||Date.now()>y(this,fe).sessionData.softExpiry))return y(this,fe).sessionData.idToken}},{key:"isExpired",get:function(){return!(!this.isLoggedIn&&!this.isOffgrid)&&Date.now()>y(this,fe).expires}},{key:"isLoggedIn",get:function(){return void 0!==y(this,fe).sessionData}},{key:"isOffgrid",get:function(){var e=y(this,fe).isOffgrid,t=y(this,fe).expires;return e&&Date.now()<t}},{key:"user",get:function(){var e;return null==(e=y(this,fe).sessionData)?void 0:e.user}},{key:"identities",get:function(){var e;return null==(e=y(this,fe).sessionData)?void 0:e.identities}},{key:"userProblem",get:function(){var e;return null==(e=y(this,fe).sessionData)?void 0:e.userProblem}}]),e}();fe=new WeakMap;var me,we,ye,_e,be,Se=0,Pe=!1,Ee=void 0,ke=3e4,Oe=function(){function e(e,t,n){var r,o=this;_(this,me,void 0),this._loginDisabled=!1,_(this,we,void 0),_(this,ye,void 0),_(this,_e,void 0),_(this,be,Date.now()),this.config=e,this.logger=t,this.sessionState={isOffgrid:Pe,expires:Se,sessionData:Ee},b(this,me,new pe(this.sessionState)),this.internalComms=n,r=function(){try{return Promise.resolve(o.checkOfGridAndToken())}catch(e){return Promise.reject(e)}},document.addEventListener("visibilitychange",(function(){"visible"===document.visibilityState&&r&&r()}))}var n=e.prototype;return n.bootstrap=function(){var e=this,t=K(ne);if(this.logger.debug("server signal: "+t),t)switch(t){case X.refresh:return this.logger.debug("starting to refresh session (server told me so)"),void this._refresh().then((function(){Q(ne)}));case X.refreshWithDefaultIdentity:return this.logger.debug("starting to refresh session with default identity (server told me so)"),void this._refresh("_").then((function(){Q(ne)}));case X.refreshOpsession:return void this._refresh().then((function(){e.logger.info("opsession logged in"),e.dispatchUpdateEvent("opsession_login",{detail:e._session}),Q(ne)}));case X.reauthenticate:return Q(ne),void this.internalComms.reauthenticate();case X.logout:return Q(ne),void this._updateState({state:"LoggedOut",userAction:"Nothing"});case X.logoutOpsession:return Q(ne),this._updateState({state:"LoggedOut",userAction:"Nothing"}),this.logger.info("opsession logged out"),void window.setTimeout((function(){e.dispatchUpdateEvent("opsession_logout",{detail:e._session})}),10)}else this._syncLoginStatusWithServer();var n=this._loadSessionIdentity(),r=this._filterOutUnavailableIdentity(n),o=this._loadSessionState(r);o&&(this.sessionState.expires=o.expires,this.sessionState.isOffgrid=o.isOffgrid,this.sessionState.sessionData=o.sessionData,this.logger.debug("bootstrapped state:",o),(o.isOffgrid||void 0!==o.sessionData)&&this._scheduleRefresh(o.expires,!0))},n._syncLoginStatusWithServer=function(){try{var e=this,t=!!K("nrk-auth-flag");return Promise.resolve(e.getSession()).then((function(n){t&&!n.isLoggedIn?e.internalComms.reauthenticate():!t&&n.isLoggedIn&&e._updateState({state:"LoggedOut",userAction:"Nothing"})}))}catch(e){return Promise.reject(e)}},n.getSession=function(){try{var e=function(e){if(t)return e;if(!n._session.isExpired){if(n.logger.debug("found data fresh enough in local variable, using that"),n._session.isOffgrid){var r=n._session.expires-(new Date).getTime();n.logger.debug("unfortunately, we are offgrid at the moment, will try to resume ongrid in "+r/1e3+" seconds")}return n._session}return Promise.resolve(n._refresh())},t=!1,n=this;n.logger.debug("starting to get session");var r=y(n,we),o=function(){if(r)return n.logger.debug("ongoing fetch for session found, awaiting that result"),Promise.resolve(r).then((function(e){return t=!0,e}))}();return Promise.resolve(o&&o.then?o.then(e):e(o))}catch(e){return Promise.reject(e)}},n._scheduleRefresh=function(e,t){var n=this;void 0===t&&(t=!1),window.clearTimeout(y(this,ye)),b(this,_e,e),b(this,ye,void 0);var r=e-Date.now();if(!t&&r<0)this.logger.warn("attempted to schedule refresh with negative duration: "+r);else{var o=this._session.isOffgrid&&!this._session.isLoggedIn,i=function(){o?n._updateState({state:"LoggedOut",userAction:"Nothing"}):n._refresh()};if(r<=0)i();else{var s=Date.now()+r;this.logger.debug("scheduled "+(t?"forced ":"")+"refresh for: "+new Date(s).toTimeString()),b(this,ye,window.setTimeout(i,r))}}},n._refresh=function(e){var t=this;return y(this,we)||(this.logger.debug("no ongoing fetch, starting to refresh"),b(this,we,this._fetchSessionState(e).then((function(e){return b(t,we,void 0),t.logger.debug("---sessionFetchResponse---",e),e})))),this.logger.debug("ongoing fetch found, returning that result to caller"),y(this,we)},n._fetchSessionState=function(e){try{var t,n,r,o,i=this,s=null!=(r=null!=(n=null!=e?e:null==(t=i.sessionState.sessionData)?void 0:t.user.sub)?n:i._loadSessionIdentity())?r:"_",a=Z.replace("{sub}",s);return Promise.resolve(B(a,void 0,i._session)).then((function(e){return Promise.resolve(i._handleSessionDataFetchResponse(e,null==(o=i._session.user)?void 0:o.sub)).then((function(){return i._session}))}))}catch(e){return Promise.reject(e)}},n._clearStoredSessionState=function(){V(re,void 0),V(oe,void 0),V(ie,void 0)},n._loadSessionIdentity=function(){return z(ie)},n._persistCurrentSessionState=function(e){var t;V(re,e),V(ie,null==(t=e.sessionData)?void 0:t.user.sub)},n._archiveKnownSessionState=function(e){var t,n;if(void 0===e.sessionData)V(oe,{records:[]});else if(null==(t=e.sessionData)?void 0:t.user.sub){var r=z(oe);void 0===r&&(r={records:[]}),r.records=r.records.filter((function(t){var n;return t.sub!==(null==(n=e.sessionData)?void 0:n.user.sub)})),r.records.push({sub:null==(n=e.sessionData)?void 0:n.user.sub,sessionState:e}),r.records.forEach((function(t){var n;void 0!==t.sessionState.sessionData&&void 0!==(null==(n=e.sessionData)?void 0:n.identities)&&(t.sessionState.sessionData.identities=e.sessionData.identities)})),V(oe,r)}},n._changeIdentity=function(e){try{var t,n=function(e){return r?e:o._session},r=!1,o=this;o.logger.debug("fetch session data (for new sub: "+e+")");var i=!1,s=l((function(){function n(t){if(r)return t;var n=Z.replace("{sub}",e);return Promise.resolve(B(n,void 0,o._session)).then((function(t){return i=!0,Promise.resolve(o._handleSessionDataFetchResponse(t,e,!0)).then((function(){}))}))}if(!o._session.isExpired&&(null==(t=o._session.user)?void 0:t.sub)===e){o.logger.debug("Short-circuiting swap sub, nothing to do");var s=o._session;return r=!0,s}var a=o._loadSessionState(e),u=function(){if((null==a?void 0:a.sessionData)&&a.expires>Date.now())return Promise.resolve(o._handleSessionDataFetchResponse({body:{session:a.sessionData,state:"LoggedIn",userAction:"Nothing"},status:200},e)).then((function(){var e=o._session;return r=!0,e}))}();return u&&u.then?u.then(n):n(u)}),(function(e){throw o.logger.error("Got error while changing identity: ",e),i||o.dispatchErrorEvent({name:"identitychange_error",message:e}),e}));return Promise.resolve(s&&s.then?s.then(n):n(s))}catch(e){return Promise.reject(e)}},n._loadSessionState=function(e){var t,n=z(re);if(void 0===e)return n;if((null==(t=null==n?void 0:n.sessionData)?void 0:t.user.sub)===e)return n;var r=z(oe);void 0===r&&(r={records:[]});var o=r.records.filter((function(t){return t.sub===e}));return o.length>0?o[0].sessionState:void 0},n._handleSessionDataFetchResponse=function(e,t,n){try{var r,o,i,s,a=function(e){var r=!1;if(u)return e;function o(e){return r?e:function(){if(h)return Promise.resolve(c._updateState(h,d,t,n))}()}var i=function(){if(l){var e=function(e){if(r)return e;function i(e){return Promise.resolve(c._updateState({state:"LoggedOut",userAction:"Nothing"},d||ke)).then((function(){return Promise.resolve(c._handleError(l,n)).then((function(e){return r=!0,e}))}))}var s=function(){if(o)return Promise.resolve(c._updateState({session:o,state:"LoggedIn",userAction:"Nothing"},d||ke,t)).then((function(e){return r=!0,e}))}();return s&&s.then?s.then(i):i()},o=c.sessionState.sessionData;if(t&&t!==(null==o?void 0:o.user.sub)){var i=c._loadSessionState(t);o=(null==i?void 0:i.sessionData)||c.sessionState.sessionData}if(f&&o&&(null==o?void 0:o.user.sub)&&o.user.sub!==t&&(c.dispatchErrorEvent({name:"identitychange_error",message:l.message}),n))throw l;var s=function(){if((null==o?void 0:o.hardExpiry)&&o.hardExpiry>Date.now())return Promise.resolve(c._updateState({session:o,state:"LoggedIn",userAction:"Nothing"},0,t)).then((function(e){return r=!0,e}))}();return s&&s.then?s.then(e):e(s)}}();return i&&i.then?i.then(o):o(i)},u=!1,c=this,f=!(void 0===(null==(o=null==(r=c._session)?void 0:r.user)?void 0:o.sub))&&void 0!==t&&void 0!==(null==(i=c._session.user)?void 0:i.sub)&&t!==(null==(s=c._session.user)?void 0:s.sub),l=e.error,h=e.body,d=e.offgridTimeout,g=function(){if(c._loginDisabled)return c.logger.warn("Login has been disabled by an innlogging-web debugging feature. Will pretend to be logged out no matter what."),Promise.resolve(c._updateState({state:"LoggedOut",userAction:"Nothing"},void 0)).then((function(e){return u=!0,e}))}();return Promise.resolve(g&&g.then?g.then(a):a(g))}catch(e){return Promise.reject(e)}},n._handleUnexpectedIdentityFromServer=function(e,t,n){try{var r=this;if(void 0===r.sessionState.sessionData||void 0===e.sessionData)return r.logger.error("Got unexpected identity problem, but there is no current session.. weird!"),Promise.resolve(r._handleLogout(!1));if(r.sessionState.sessionData.identities=e.sessionData.identities,t){if(r.dispatchCustomEvent("changeidentity_error",{detail:r._session}),n)throw new Error("could not change identity")}else if(r.dispatchCustomEvent("unexpected_identity",{detail:r._session}),n)throw new Error("unexpected identity");return Promise.resolve()}catch(e){return Promise.reject(e)}},n._handleLogout=function(e){try{var t=this;t._clearStoredSessionState(),t.sessionState.isOffgrid=!1,t.sessionState.expires=0,t.sessionState.sessionData=void 0;var n=e?"logout_success":"unexpected_logout";return t.dispatchUpdateEvent(n,{detail:t._session}),t.internalComms.logout(),Promise.resolve()}catch(e){return Promise.reject(e)}},n._handleOffgridLogout=function(e,t){try{var n=this;n._clearStoredSessionState(),n.sessionState.isOffgrid=!0,n.sessionState.expires=Date.now()+t,n.sessionState.sessionData=void 0;var r=e?"logout_success":"unexpected_logout";return n.dispatchUpdateEvent(r,{detail:n._session}),Promise.resolve()}catch(e){return Promise.reject(e)}},n._updateState=function(e,t,n,r){void 0===t&&(t=0),void 0===r&&(r=!1);try{var o,i,s,a=!1,u=this,c=void 0===(null==(o=u._session.user)?void 0:o.sub),f=!c&&void 0!==n&&void 0!==(null==(i=u._session.user)?void 0:i.sub)&&n!==(null==(s=u._session.user)?void 0:s.sub),h=u._session.isOffgrid;return Promise.resolve(function(){if(e){var o=function(o){return a?o:"MustReauthenticate"!==s?function(){if("LoggedIn"===i){var o=e.session;0!==o.softExpiresIn&&(o.softExpiry=Date.now()+o.softExpiresIn,o.softExpiresIn=0),0!==o.expiresIn&&(o.hardExpiry=Date.now()+o.expiresIn,o.expiresIn=0);var s=void 0!==(null==o?void 0:o.hardExpiry)&&o.hardExpiry<Date.now(),a=s,d=o.softExpiry;t>0&&(d=Date.now()+t,a=!0),o.hardExpiry>Date.now()&&o.hardExpiry<d&&(d=o.hardExpiry),d<=Date.now()&&(d=Date.now()+ke);var g={isOffgrid:a,expires:d,sessionData:o};return Promise.resolve(u._archiveKnownSessionState(g)).then((function(){var e=!1;function t(t){var n=!1;if(e)return t;function i(e){if(n)return e;u.sessionState.expires=d,u.sessionState.isOffgrid=a,u.sessionState.sessionData=o,d&&u._scheduleRefresh(d),f?u.dispatchUpdateEvent("changeidentity_success",{detail:u._session}):c?u.dispatchUpdateEvent("login_success",{detail:u._session}):u.dispatchUpdateEvent("refresh_success",{detail:u._session}),u.logger.debug("update state:",g);try{u._persistCurrentSessionState(g)}catch(e){u._handleError(e)}}var s=function(){if(u.internalComms.onSessionDataLoaded)return l((function(){return Promise.resolve(u.internalComms.onSessionDataLoaded(o)).then((function(){}))}),(function(e){u.logger.error("Got error while handling session data response",e);var t=c?"login_error":f?"changeidentity_error":"refresh_error";if(u.dispatchCustomEvent(t,{detail:{error:e}}),r)throw e;n=!0}))}();return s&&s.then?s.then(i):i(s)}!h&&s&&u.dispatchUpdateEvent("going_offgrid",{detail:u._session}),h&&!s&&u.dispatchUpdateEvent("going_ongrid",{detail:u._session});var i=function(){if(n&&o.user.sub!==n)return Promise.resolve(u._handleUnexpectedIdentityFromServer(g,f,r)).then((function(t){return e=!0,t}))}();return i&&i.then?i.then(t):t(i)}))}}():void u.internalComms.reauthenticate()},i=e.state,s=e.userAction,d=function(){if("LoggedOut"===i||"MustLogOut"===s){var e=function(e){return a?e:Promise.resolve(u._handleLogout(!0)).then((function(){h&&u.dispatchUpdateEvent("going_ongrid",{detail:u._session}),a=!0}))},n=function(){if(t>0)return Promise.resolve(u._handleOffgridLogout(!1,t)).then((function(){h||u.dispatchUpdateEvent("going_offgrid",{detail:u._session}),a=!0}))}();return n&&n.then?n.then(e):e(n)}}();return d&&d.then?d.then(o):o(d)}if(t>0){u.sessionState.expires=Date.now()+t,u.sessionState.isOffgrid=!0;try{u._persistCurrentSessionState(u.sessionState)}catch(e){u._handleError(e)}}}())}catch(e){return Promise.reject(e)}},n.goOffgrid=function(e){this._updateState(void 0,null!=e?e:ke)},n.goOngrid=function(){this._updateState(void 0,0)},n.logout=function(){try{return this._updateState({state:"LoggedOut",userAction:"Nothing"}),Promise.resolve()}catch(e){return Promise.reject(e)}},n._handleError=function(e,t){if(void 0===t&&(t=!1),this.logger.error(e),this.dispatchErrorEvent({name:"error",message:e.message}),t)throw e},n._filterOutUnavailableIdentity=function(e){var t=z(re);if((null==t?void 0:t.sessionData)&&(null==t?void 0:t.sessionData.identities.filter((function(t){return t.sub==e}))).length>0)return e},n.dispatchUpdateEvent=function(e,t){this.internalComms.eventDispatchFunc(new CustomEvent(e,t)),this.internalComms.eventDispatchFunc(new CustomEvent("update",t))},n.dispatchCustomEvent=function(e,t){this.internalComms.eventDispatchFunc(new CustomEvent(e,t))},n.dispatchErrorEvent=function(e){this.internalComms.eventDispatchFunc(new ErrorEvent("error",e))},n.checkOfGridAndToken=function(){try{var e=this,t=function(){if(e._session.isLoggedIn&&e._session.isOffgrid||e._session.isLoggedIn&&e._session.isExpired){var t="Refreshed token. Status Loggedin "+e._session.isLoggedIn+" status Is offGrid "+e._session.isOffgrid+" status is expired: "+e._session.isExpired;return Promise.resolve((n=150,new Promise((function(e){return setTimeout(e,n)})))).then((function(){return Promise.resolve(e._refresh()).then((function(){e.logger.debug(t)}))}))}var n}();return Promise.resolve(t&&t.then?t.then((function(){})):void 0)}catch(e){return Promise.reject(e)}},t(e,[{key:"_session",get:function(){return y(this,me)},set:function(e){b(this,me,e)}},{key:"_fetchSessionPromise",get:function(){return y(this,we)}},{key:"_refreshTimeoutId",get:function(){return y(this,ye)}},{key:"_nextRefresh",get:function(){return y(this,_e)}},{key:"_lastForceRefresh",get:function(){return y(this,be)}}]),e}();me=new WeakMap,we=new WeakMap,ye=new WeakMap,_e=new WeakMap,be=new WeakMap;var Ie={logLevel:g.error,logger:console.log},Le=function(e){function o(t,r,o){var i;return void 0===r&&(r="LoginClient"),(i=e.call(this)||this).config=n({},Ie,t),i.logger=new E(r,t.logHandler),i.core=new Oe(i.config,i.logger,o),i.debug=new ge(u(i),i.core),i}r(o,e);var i=o.prototype;return i.getSession=function(){try{return Promise.resolve(this.core.getSession())}catch(e){return Promise.reject(e)}},i.getSessionState=function(){try{return Promise.resolve(this.core.sessionState)}catch(e){return Promise.reject(e)}},i.forceRefresh=function(){try{return Promise.resolve(this._refresh())}catch(e){return Promise.reject(e)}},i.migrateRefreshToken=function(e){try{return this.logger.warn("deprecated"),Promise.resolve(this.getSession())}catch(e){return Promise.reject(e)}},i.updateProfile=function(e,t){try{var n=this;return Promise.resolve(n.core.getSession()).then((function(r){if(!r.isLoggedIn)throw Error("user is not logged in");if(r.isOffgrid)throw Error("authority offgrid");var o=function(){if(r.user){var o="/auth/updateprofiledata/"+e;return Promise.resolve(H(o,t,r)).then((function(t){var o=function(){if("refresh"===K(ne))return Promise.resolve(n._refresh()).then((function(){Q(ne)}));var o=function(){if("refresh"===t.loginSignal)return Promise.resolve(n._refresh()).then((function(){}));var o=function(){if(r.user.sub===e)return Promise.resolve(n._refresh()).then((function(){}))}();return o&&o.then?o.then((function(){})):void 0}();return o&&o.then?o.then((function(){})):void 0}();if(o&&o.then)return o.then((function(){}))}))}}();return o&&o.then?o.then((function(){return r})):r}))}catch(e){return Promise.reject(e)}},i.changeIdentity=function(e){try{return Promise.resolve(this.core._changeIdentity(e))}catch(e){return Promise.reject(e)}},i.postponeUserProblem=function(){try{var e,t=this;return Promise.resolve(t.getSession()).then((function(n){var r=null==(e=n.userProblem)?void 0:e.postponeApiUrl;if(!r)throw Error("Missing postpone api url");return Promise.resolve(B(r,void 0,n)).then((function(){return Promise.resolve(t._refresh()).then((function(){}))}))}))}catch(e){return Promise.reject(e)}},i.addEventListener=function(t,n){var r=this,o=n;e.prototype.addEventListener.call(this,t,o),"update"===t&&null!==n&&Promise.resolve().then((function(){o(new CustomEvent("update",{detail:r.core._session}))}))},i.removeEventListener=function(t,n){e.prototype.removeEventListener.call(this,t,n)},i._bootstrap=function(){try{this.logger.info("bootstrapping login client"),this.core.bootstrap()}catch(e){this._handleError(e)}},i._refresh=function(e){return this.core._refresh(e)},i._handleError=function(e,t){if(void 0===t&&(t=!1),this.logger.error(e),this.dispatchEvent(new ErrorEvent("error",{error:e,message:e.message})),t)throw e},i._handleSessionDataFetchResponse=function(e,t,n){try{return Promise.resolve(this.core._handleSessionDataFetchResponse(e,t,n))}catch(e){return Promise.reject(e)}},i.generateInviteCode=function(e){try{var t=this;return Promise.resolve(t.getSession()).then((function(n){return Promise.resolve(B("/auth/invitecode/generate",{codeChallenge:null!=e?e:""},n)).then((function(e){var n=e.body,r=e.error,o=e.offgridTimeout;if(o&&t.core.goOffgrid(o),r)throw t._handleError(r),r;if(n)return n.inviteCode;var i=new Error("No body returned from generateInviteCode endpoint");throw t._handleError(i),i}))}))}catch(e){return Promise.reject(e)}},i._getContextInfo=function(){try{var e,t=this;if(void 0!==t.contextInfo)return Promise.resolve(t.contextInfo);var n=K(se);return n&&(t.contextInfo=JSON.parse(decodeURIComponent(n))),(null==(e=t.contextInfo)?void 0:e.authority)?Promise.resolve(t.contextInfo):Promise.resolve(G(ee)).then((function(e){return t.contextInfo=e.body,t.contextInfo}))}catch(e){return Promise.reject(e)}},i._updateContextInfo=function(){try{var e=this;return Promise.resolve(G(ee)).then((function(t){return e.contextInfo=t.body,Promise.resolve(e._contextInfoUpdated()).then((function(){}))}))}catch(e){return Promise.reject(e)}},i._contextInfoUpdated=function(){return Promise.resolve()},i.getUrlWithExpiryExtended=function(e,t){try{var r=this,o=te+"/"+e.key;return Promise.resolve(r.getSession()).then((function(i){return Promise.resolve(B(o,n({scope:t},e),i)).then((function(e){var t=e.body,n=e.error;if(n)throw n;if(t)return t;var o=new Error("No body returned from generateUrlWithExpiry endpoint");throw r._handleError(o),o}))}))}catch(e){return Promise.reject(e)}},i.getUrlWithExpiry=function(e,t){try{var n=this;return Promise.resolve(n.getSession()).then((function(r){return Promise.resolve(B(te+"/"+e,{scope:t},r)).then((function(e){var t=e.body,r=e.error;if(r)throw r;if(t)return t;var o=new Error("No body returned from generateUrlWithExpiry endpoint");throw n._handleError(o),o}))}))}catch(e){return Promise.reject(e)}},t(o,[{key:"version",get:function(){return o.version}},{key:"_nextRefresh",get:function(){return this.core._nextRefresh}}]),o}(a(EventTarget)),xe=Le;xe.version="8.7.0";var De,Ue,je,Te,Ce,Re="opsession_login_attempted",Ae=function(e,t,n,r,o,i,s,a){this.firstMessage=!0,this.opSessionIframeId=i,this.opSessionInterval=n,this.opOrigin=e,this.opSessionIframeUrl=t,this.opLoginOnFirstMessageOnly=r,this.opLogoutOnFirstMessageOnly=o,this.overrideOpOrigin=s,this.overrideOpSessionIframeUrl=a},Ne=function(){function e(e,t,n){_(this,De,void 0),_(this,Ue,void 0),_(this,je,!1),_(this,Te,0),_(this,Ce,0),this.opSessionState="",this.iframe=void 0,b(this,De,e),this.config=this._computeConfig("",n),this.logger=new E("opsession"),void 0!==t?(this._adjustConfig(t),this.context=t):this.logger.error("contextInfo is undefined")}var n=e.prototype;return n.inIframe=function(){try{return window.self!==window.top}catch(e){return!0}},n._adjustConfig=function(e){this.config.opOrigin=this.config.overrideOpOrigin||e.authority,this.config.opSessionIframeUrl=this.config.overrideOpSessionIframeUrl||e.authority+"/nonstandard/opsession",this.config.firstMessage=!0},n.init=function(e){try{var t,n,r=this;return r.stop(),r.inIframe()?(r.logger.debug("OpSession is not supported from within iframe, will not start"),Promise.resolve()):void 0===e?(r.logger.warn("OpSessionHandler needs contextInfo to work, will not start"),Promise.resolve()):"1"===K("login_opsession_deactivate")?(r.logger.debug("OpSession is deactivated from serverside, (we are most likely in a app/webview context)"),Promise.resolve()):Promise.resolve(y(r,De).getSession()).then((function(e){function o(){"reauthenticate"!==r.opSessionState?"offgrid"!==r.opSessionState?(r.iframe=document.createElement("iframe"),r.iframe.id=r.config.opSessionIframeId,r.iframe.src=r.config.opSessionIframeUrl+"?d="+(new Date).getTime(),r.iframe.style.display="none",b(r,Ue,window.setInterval((function(){return r._periodicCheck()}),r.config.opSessionInterval)),y(r,je)||(r._eventListener=function(e){e.origin===r.config.opOrigin&&("unchanged"!==e.data&&(window.clearInterval(y(r,Ue)),b(r,je,!1)),r.handle(e))},window.addEventListener("message",r._eventListener),b(r,je,!0)),document.body.appendChild(r.iframe)):r.logger.info("Offgrid mode: no check will be made against authority opsession frame"):y(r,De)._performOpSessionLogin()}if(!e.isOffgrid){var i=K("nrk-login-session-state"),s=function(){if(!i)return Promise.resolve(G("/auth/opsession/state")).then((function(e){r.opSessionState=null!=(n=null==(t=e.body)?void 0:t.opSessionState)?n:"none"}));r.opSessionState=i}();return s&&s.then?s.then(o):o()}r.logger.warn("We are offgrid now, OpSession will not start)")}))}catch(e){return Promise.reject(e)}},n.stop=function(e){void 0===e&&(e=!1),b(this,Te,0),b(this,Ce,0),y(this,Ue)&&window.clearInterval(y(this,Ue)),this.iframe&&this.iframe.remove(),this._eventListener&&(window.removeEventListener("message",this._eventListener),this._eventListener=void 0),e&&Q(Re)},n._periodicCheck=function(){var e,t;try{S(this,Ce)._++;var n=null==(e=this.iframe)?void 0:e.contentWindow;null==n||n.postMessage((null==(t=this.context)?void 0:t.clientId)+" "+this.opSessionState,"*")}catch(e){S(this,Te)._++,y(this,Te)>5&&(this.logger.warn("Error connecting to the opsession frame, giving up"),this.stop())}},n._computeConfig=function(e,t){var n;return new Ae((null==t?void 0:t.overrideOpOrigin)||e,null!=(n=null==t?void 0:t.overrideOpSessionIframeUrl)?n:e+"/nonstandard/opsession",(null==t?void 0:t.opSessionInterval)||2e3,(null==t?void 0:t.opLoginOnFirstMessageOnly)||!0,(null==t?void 0:t.opLogoutOnFirstMessageOnly)||!1,(null==t?void 0:t.opSessionIframeId)||"opsession_frame",null==t?void 0:t.overrideOpOrigin,null==t?void 0:t.overrideOpSessionIframeUrl)},n.handle=function(e){var t=this.config.firstMessage||!this.config.opLoginOnFirstMessageOnly,n=this.config.firstMessage||!this.config.opLogoutOnFirstMessageOnly;switch(e.data){case"changed":var r=parseInt(K(Re)||"0");t&&r<3&&($(Re,""+(r+1),18e4),y(this,De)._performOpSessionLogin());break;case"ended":Q(Re),n&&y(this,De)._performOpSessionLogout();break;case"unchanged":Q(Re)}this.config.firstMessage=!1},t(e,[{key:"_client",get:function(){return y(this,De)}},{key:"_timer",get:function(){return y(this,Ue)}},{key:"_listening",get:function(){return y(this,je)}},{key:"_failCounter",get:function(){return y(this,Te)}},{key:"_attemptCounter",get:function(){return y(this,Ce)}}]),e}();De=new WeakMap,Ue=new WeakMap,je=new WeakMap,Te=new WeakMap,Ce=new WeakMap;var We,Me="nrk-login-reauthenticated",Fe=function(e){function t(t,n){var r,o={reauthenticate:function(){},logout:function(){},onSessionDataLoaded:null!=n?n:function(){try{return Promise.resolve(new Promise((function(e){return e()}))).then((function(){}))}catch(e){return Promise.reject(e)}},eventDispatchFunc:function(e){return!0}};return r=e.call(this,t,"RedirectLoginClient",o)||this,o.reauthenticate=r._reauthenticate.bind(u(r)),o.logout=r._localLogout.bind(u(r)),o.eventDispatchFunc=r.dispatchEvent.bind(u(r)),r._bootstrap(),r}r(t,e);var n=t.prototype;return n.initOpSession=function(){try{var e=this;return e.isLocalDev()&&!e.isATestRun()?(e.logger.warn("opsession disabled for http and localhost"),Promise.resolve()):Promise.resolve(e._getContextInfo()).then((function(t){e.opSession=new Ne(e,t,e.config);var n=function(){if(void 0!==(null==t?void 0:t.authority))return Promise.resolve(e.opSession.init(t)).then((function(){}))}();if(n&&n.then)return n.then((function(){}))}))}catch(e){return Promise.reject(e)}},n.isLocalDev=function(){return"http:"===window.location.protocol||"localhost"===window.location.hostname},n.isATestRun=function(){return"http:"===window.location.protocol&&"localhost"===window.location.hostname&&"8888"===window.location.port},n.login=function(e){var t;if(void 0===e&&(e={}),this.core._session.isOffgrid)throw Error("authority offgrid: unable to make attempt for "+(this.core._session.expires-Date.now())+"ms");var n=new URL("/auth/web/login",window.location.href);for(var r in e){var o=e[r];o&&n.searchParams.set(r,Array.isArray(o)?o.join(","):o.toString())}var i=new URL(null!=(t=e.returnUrl)?t:window.location.href,window.location.href);e.selectIdentityOnAuthority?i=this._getSelectIdentityOnAuthorityUrl(i):"Child"===e.profileType&&(i=this._getPickChildProfileUrl(i)),this._navigateWithReturnUrl(n,i.href)},n._performOpSessionLogin=function(){this._navigateWithReturnUrl(new URL("/auth/web/login/opsession",window.location.href))},n.logout=function(e){void 0===e&&(e={});var t=e,n=t.returnUrl,r=void 0===n?window.location.href:n,o=t.suppressUserConfirmation,i=new URL(void 0===o||o?"/auth/web/logout/central":"/auth/web/logout/tentative",window.location.href);this._navigateWithReturnUrl(i,r)},n._performOpSessionLogout=function(){this._navigateWithReturnUrl(new URL("/auth/web/logout/opsession",window.location.href))},n._navigate=function(e,t){return void 0===t&&(t=!1),t||(window.location.href=e.href),e},n._navigateWithReturnUrl=function(e,t,n){void 0===n&&(n=!1);var r=null!=t?t:window.location.href;return e.searchParams.set("returnUrl",r),this._navigate(e,n)},n.navigateTo=function(e){try{var t,n=this;return Promise.resolve(n._resolveNavigationTarget(e)).then((function(e){e.body&&n._navigate(new URL(null==(t=e.body)?void 0:t.urlComplete,window.location.href))}))}catch(e){return Promise.reject(e)}},n._resolveNavigationTarget=function(e){try{return e.returnUrl=e.returnUrl||new URL(window.location.href),Promise.resolve(this.getSession()).then((function(t){return B("/auth/url/generate",e,t)}))}catch(e){return Promise.reject(e)}},n.fixUserProblem=function(e){try{var t=this;return Promise.resolve(t._resolveNavigationTarget({target:"urlcomplete",urlComplete:e.fixUrlComplete})).then((function(e){e.body&&t._navigate(new URL(e.body.urlComplete,window.location.href))}))}catch(e){return Promise.reject(e)}},n._localLogout=function(){this._navigateWithReturnUrl(new URL("/auth/web/logout/local",window.location.href))},n._getSelectIdentityOnAuthorityUrl=function(e){var t,n=new URL("/auth/web/selectidentity",window.location.href);return n.searchParams.set("returnUrl",null!=(t=null==e?void 0:e.href)?t:window.location.href),n},n._getPickChildProfileUrl=function(e){var t,n=new URL("/auth/web/selectchildprofileidentity",window.location.href);return n.searchParams.set("returnUrl",null!=(t=null==e?void 0:e.href)?t:window.location.href),n},n.selectIdentityOnAuthority=function(){try{var e=this._getSelectIdentityOnAuthorityUrl();return this._navigate(e),Promise.resolve()}catch(e){return Promise.reject(e)}},n._reauthenticate=function(){"1"!==K(Me)?($(Me,"1",3e5),this._navigateWithReturnUrl(new URL("/auth/web/login/reauthenticate",window.location.href))):this.logger.warn("skipping reauthentication since we already reauthenticated less than 5 minutes ago")},n._contextInfoUpdated=function(){try{var e;return null==(e=this.opSession)||e.init(this.contextInfo),Promise.resolve()}catch(e){return Promise.reject(e)}},n.ensureUserConformsToRequirements=function(e){try{var t=this;return Promise.resolve(t.getSession()).then((function(n){if(!n.isLoggedIn){var r=Object.assign({},e);return r.returnUrl=window.location.href,void t.login(r)}var o=function(){if(!n.userConformsToRequirements(e))return Promise.resolve(t._resolveNavigationTarget({target:"fixuserrequirements",requirements:(e.requirements||[]).join(","),requirementsIntro:e.requirementsIntro||"",outro:encodeURIComponent(e.outro||"")})).then((function(e){e.body&&t._navigateWithReturnUrl(new URL(e.body.urlComplete,window.location.href))}))}();if(o&&o.then)return o.then((function(){}))}))}catch(e){return Promise.reject(e)}},t}(xe);var qe=new URLSearchParams(window.location.search),Ge=qe.get("viewContext"),Be=qe.get("appVersion"),He="no.nrk.mobil.nrknoapp"===Ge,Je="no.nrk.mobil.app"===Ge;function ze(e,t){var n=function(e){return e.split(".").map(Number)},r=n(e),o=r[0],i=r[1],s=void 0===i?0:i,a=r[2],u=void 0===a?0:a,c=n(t),f=c[0],l=c[1],h=void 0===l?0:l,d=c[2],g=void 0===d?0:d;return o!==f?o>f?1:-1:s!==h?s>h?1:-1:u!==g?u>g?1:-1:0}var Ve=He||Je,Ke=Ve&&null!==Be&&(He&&ze(Be,"6")>=0||Je&&ze(Be,"5")>=0);document.cookie.indexOf("nrkno-sub")>=0&&localStorage.setItem("legacy-cookies","true");var $e,Qe,Xe,Ye=(void 0!==($e={logLevel:g.error}).logLevel&&(Xe=$e.logLevel,P=Xe),We||(We=new Fe($e,Qe)),We);Ye.addEventListener("update",(function(e){var t=e.detail,n=t.isLoggedIn,r=t.user;n&&r?localStorage.setItem("nrkno-sub",r.sub):localStorage.removeItem("nrkno-sub")})),function(e){if(Ve)return;e.addEventListener("opsession_logout",(function(){localStorage.removeItem("nrkno-sub"),location.reload()})),e.addEventListener("opsession_login",(function(e){var t,n=e.detail,r=n.isLoggedIn,o=n.user;r&&o&&(localStorage.getItem("legacy-cookies")?localStorage.removeItem("legacy-cookies"):((t=new URL(location.href)).searchParams.set("autoLogin","true"),location.replace(t.href)))})),e.initOpSession()}(Ye);var Ze={};Object.defineProperty(Ze,"__esModule",{value:!0});var et={};function tt(e,t){if("string"!=typeof e)throw new Error("topic must be a string");if("function"!=typeof t)throw new Error("Handler must be of topic function");(et[e]=et[e]||[]).push(t)}function nt(e,t){if("string"!=typeof e)throw new Error("topic must be a string");et[e]=(et[e]||[]).filter((function(e){return t&&e!==t}))}function rt(e,t){if("string"!=typeof e)throw new Error("type must be a string");if("function"!=typeof t)throw new Error("Handler must be of type function");tt(e,(function n(){for(var r=[],o=arguments.length;o--;)r[o]=arguments[o];nt(e,n),t.apply(void 0,r)}))}function ot(e,t){if(void 0===t&&(t={}),window.webkit&&window.webkit.messageHandlers)window.webkit.messageHandlers.nativebridgeiOS.postMessage({topic:e,data:t});else{if(!window.NativeBridgeAndroid)throw new Error("No native bridge defined");window.NativeBridgeAndroid.send(JSON.stringify({topic:e,data:t}))}}function it(e){var t=e.topic,n=e.data,r=e.resolve,o=e.reject,i=e.timeout;if("string"!=typeof t)throw TypeError("topic argument must be a String");if(null===n||"object"!=typeof n)throw TypeError("data argument must be an Object");if("function"!=typeof r)throw new TypeError("resolve must be a function");if("function"!=typeof o)throw new TypeError("resolve must be a function");if("number"!=typeof i)throw new TypeError("timeout must be a number");return!0}function st(e){var t=e.detail,n=t.topic,r=t.data;(et[n]||[]).forEach((function(e){return e(r)}))}function at(){window.addEventListener("nativebridge",st)}"undefined"!=typeof window&&at(),Ze.events=et,Ze.on=tt,Ze.off=nt,Ze.once=rt;var ut=Ze.emit=ot;Ze.validateRpcInput=it,Ze.rpc=function(e){var t=e.topic,n=e.data,r=e.resolve,o=e.reject,i=e.timeout;void 0===i&&(i=1e3);try{it({topic:t,resolve:r,reject:o,data:n,timeout:i});var s=!1,a=setTimeout((function(){s=!0,o(new Error("RPC for "+t+" using "+n+" timed out after "+i+"ms"))}),i);rt(t,(function(e){clearTimeout(a),e.errors?o(new Error(JSON.stringify(e.errors))):s||r(e)})),ot(t,n)}catch(e){o(e)}},Ze.setupNativeLink=at,Ze.destroy=function(){Object.keys(et).forEach((function(e){return et[e]=[]})),"undefined"!=typeof window&&window.removeEventListener("nativebridge",st)};var ct=function(e){try{return Promise.resolve(Ye.getSession()).then((function(t){var n=t.accessToken,r=t.expires;if(n){var o={accessToken:n,expiresAt:new Date(r).toISOString()};e(null,o)}else e(new Error("Not logged in"),null)}))}catch(e){return Promise.reject(e)}};function ft(e){var t=e||{},n=t.redirectPath,r=t.language,o=t.context,i=t.intro,s=t.outro,a=t.requirements,u={returnUrl:n,language:dt(r),requirements:null==a?void 0:a.split(",").map((function(e){return e.trim()})),nrkCtx:o,loginIntro:i,outro:s};if(!Ve)return Ye.login(u);ut("presentLogin",{context:o})}function lt(e){var t={returnUrl:(e||{}).redirectPath,suppressUserConfirmation:!1};return Ye.logout(t)}function ht(e,t){var n={requirements:e.split(",").map((function(e){return e.trim()})),language:dt(t.language)};return Ye.ensureUserConformsToRequirements(n),!0}function dt(e){return"en-GB"===e?"enGB":"nbNO"}!function(){try{return Promise.resolve(function(){try{var e=document.referrer.includes("innlogging.nrk.no");return Promise.resolve(e?Ye.forceRefresh():Ye.getSession()).then((function(e){var t=e.user;if(!t)return!1;var n="nrk/consent/",r=Object.keys(t.claims||{}).filter((function(e){return e.startsWith(n)})).map((function(e){var n=t.claims[e];return e.slice(12)+":"+n}));return{name:t.name||"",subject:t.sub,accessToken:e.accessToken||"",accessTokenExpiry:new Date(e.expires).toISOString(),sessionState:"",consent:r,age:void 0===t.age?void 0:Number(t.age),newsRegion:t.newsRegion,sapmi:t.sapmi}}))}catch(e){return Promise.reject(e)}}()).then((function(e){var t=window.onLoginReady||!1;if(!t.ok){var n={consentTo:ht,login:ft,logout:lt,token:ct};window.onLoginReady=function(t){t(e||!1,n)},window.onLoginReady.ok=!0}t.q&&t.q.forEach((function(e){window.onLoginReady(e[0])})),Ke&&ut("loginInitialized",{loggedIn:!!e})}))}catch(e){return Promise.reject(e)}}()}();
